<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIKIDS Attendance System</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@400;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --bg: #0a0f1e; --card: #111827; --accent: #00e5ff; 
            --green: #10b981; --red: #ef4444; --text: #f1f5f9; 
            --muted: #64748b; --border: rgba(255,255,255,0.07);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Space Grotesk', 'Noto Sans Khmer', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 15px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        @media screen and (max-width: 600px) { .admin-only { display: none; } }

        .card { background: var(--card); border-radius: 15px; border: 1px solid var(--border); padding: 20px; text-align: center; margin-bottom: 20px; }
        #qrcode { background: white; padding: 10px; display: inline-block; border-radius: 10px; margin: 15px 0; }
        .scan-box { background: #1a2235; padding: 20px; border-radius: 15px; border: 1px solid var(--accent); }
        select, .btn { width: 100%; padding: 15px; margin-top: 10px; border-radius: 10px; font-size: 16px; border: none; font-weight: bold; cursor: pointer; }
        select { background: var(--bg); color: white; border: 1px solid var(--border); }
        
        .btn-morning { background: var(--green); color: white; }
        .btn-afternoon { background: #7c3aed; color: white; }
        .btn-checkout { background: var(--red); color: white; }
        .btn-summary { background: var(--accent); color: #000; margin-top: 20px; }
        .btn-reset { background: #374151; color: #f87171; margin-top: 10px; }
        
        .table-wrap { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; background: var(--card); min-width: 600px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); }
        th { background: #1f2937; color: var(--accent); }
        .late-text { color: var(--red); font-weight: bold; }

        /* ===== EDITABLE CELL STYLES ===== */
        .cell-input {
            background: transparent;
            border: none;
            color: var(--text);
            font-family: 'Space Grotesk', 'Noto Sans Khmer', sans-serif;
            font-size: 11px;
            width: 100%;
            padding: 2px 4px;
            border-radius: 5px;
            outline: none;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .cell-input:hover { background: rgba(0,229,255,0.05); }
        .cell-input:focus {
            background: rgba(0,229,255,0.08);
            box-shadow: 0 0 0 1px var(--accent);
            color: var(--accent);
            cursor: text;
        }
        .cell-input.has-value { color: #a3e635; }
        .cell-input.late-val { color: var(--red) !important; }
        .cell-input::placeholder { color: var(--muted); }
        /* ================================ */

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #1f2937; color: var(--text); padding: 12px 24px; border-radius: 10px;
            border: 1px solid var(--accent); font-size: 14px; transition: transform 0.3s ease;
            z-index: 999;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { border-color: var(--green); }
        .toast.error { border-color: var(--red); }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:var(--accent); margin-bottom:15px;">MIKIDS ATTENDANCE</h2>

    <div class="card admin-only">
        <h3>QR áŸá˜áŸ’ášá¶á”áŸ‹áŸáŸ’á€áŸá“ (Admin)</h3>
        <div id="qrcode"></div>
    </div>

    <div class="scan-box">
        <label>á‡áŸ’ášá¾áŸášá¾áŸáˆáŸ’á˜áŸ„áŸ‡á”á»á‚áŸ’á‚á›á·á€:</label>
        <select id="staff-name"></select>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
            <button class="btn btn-morning" onclick="submitAttendance('morning')">â˜€ï¸ CheckIn(Morning)</button>
            <button class="btn btn-afternoon" onclick="submitAttendance('afternoon')">ğŸŒ¤ï¸ CheckIn(Afternoon)</button>
            <button class="btn btn-checkout" onclick="submitAttendance('checkout')">ğŸšª CheckOut</button>
        </div>
    </div>

    <button class="btn btn-summary admin-only" onclick="sendSummaryToTelegram()">ğŸ“¤ á•áŸ’á‰á¾ášá”á¶á™á€á¶ášááŸáŸášá»á”á‘áŸ… Telegram</button>
    <button class="btn btn-reset admin-only" onclick="resetRecords()">ğŸ—‘ï¸ á›á»á”á‘á·á“áŸ’á“á“áŸá™ááŸ’á„áŸƒá“áŸáŸ‡ (Reset)</button>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>CheckIn (AM)</th>
                    <th>Late (AM)</th>
                    <th>CheckIn (PM)</th>
                    <th>Late (PM)</th>
                    <th>CheckOut</th>
                </tr>
            </thead>
            <tbody id="attendance-list"></tbody>
        </table>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
const CONFIG = {
    token: '8242266919:AAGE6uMJ_-UvM-3KBZkJVFhJyTLvcTVW5tQ',
    chatId: '-1003584563383',
    morningLate: '07:05',   
    afternoonLate: '13:05', 
    githubLink: 'https://chanthoeur8-cell.github.io/Attendance-staff/'
};

const STAFF_LIST = [
    { name: "Chanthoeurn chhoeurn", role: "IT" },
    { name: "Ashley villela", role: "English Teacher" },
    { name: "áœá·á“ áŸáŸášá¸á—á¶á–", role: "Assistant Teacher" },
    { name: "CHOT HORN", role: "Teacher" },
    { name: "á˜á»á¹á„ áŸáŸ’ášá¸á“á¸á", role: "Teacher" },
    { name: "á¢á¿á“ á€á¶áá¶á›áŸ‹", role: "Teacher" },
    { name: "á”áŸ‰á¼ áŸá¼áŒá·á“", role: "Admin / Teacher" },
    { name: "Leang Sopheavy", role: "Computer Teacher" },
    { name: "Chamnan Veasna", role: "English Teacher" },
    { name: "Born Chhorda", role: "Teacher" },
    { name: "SOK SREYPICE", role: "English Teacher" },
    { name: "Eng sreynin", role: "Receptionist" },
    { name: "á€á»áŸá› áŸáŸ€á€á˜áŸ‰áŸá„", role: "Assistant Teacher" },
    { name: "vat mouy saing", role: "Chinese Teacher" },
    { name: "áˆá¹á˜áœáŸ‰á¶á“ á›á¸á á„áŸ’áŸ", role: "Teacher" },
    { name: "Dorn Sreyneth", role: "English Teacher" }
];

// ========== AUTO RESET EACH DAY ==========
const TODAY = new Date().toISOString().slice(0, 10);
const storedDate = localStorage.getItem('mikids_date');
if (storedDate !== TODAY) {
    localStorage.removeItem('mikids_v2_db');
    localStorage.setItem('mikids_date', TODAY);
}

let records = JSON.parse(localStorage.getItem('mikids_v2_db')) || {};

// ========== TOAST ==========
function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast ${type} show`;
    setTimeout(() => { t.className = 'toast'; }, 3000);
}

function formatLate(totalMins) {
    if (totalMins <= 0) return "";
    const h = Math.floor(totalMins / 60);
    const m = totalMins % 60;
    return h > 0 ? `${h}á˜áŸ‰áŸ„á„ ${m}á“á¶á‘á¸` : `${m}á“á¶á‘á¸`;
}

function saveRecords() {
    localStorage.setItem('mikids_v2_db', JSON.stringify(records));
}

function renderTable() {
    const list = document.getElementById('attendance-list');
    list.innerHTML = '';
    STAFF_LIST.forEach(s => {
        const r = records[s.name] || { morning: null, afternoon: null, checkout: null };

        const amTime   = r.morning   ? r.morning.time   : '';
        const amLate   = r.morning   ? formatLate(r.morning.late) : '';
        const pmTime   = r.afternoon ? r.afternoon.time : '';
        const pmLate   = r.afternoon ? formatLate(r.afternoon.late) : '';
        const outTime  = r.checkout  ? r.checkout       : '';

        list.innerHTML += `<tr>
            <td><b>${s.name}</b></td>
            <td><input class="cell-input ${amTime ? 'has-value' : ''}" 
                placeholder="-" value="${amTime}"
                onchange="manualEdit('${s.name}','am_time',this.value,this)" /></td>
            <td><input class="cell-input late-val ${amLate ? 'has-value' : ''}" 
                placeholder="-" value="${amLate}"
                onchange="manualEdit('${s.name}','am_late',this.value,this)" /></td>
            <td><input class="cell-input ${pmTime ? 'has-value' : ''}" 
                placeholder="-" value="${pmTime}"
                onchange="manualEdit('${s.name}','pm_time',this.value,this)" /></td>
            <td><input class="cell-input late-val ${pmLate ? 'has-value' : ''}" 
                placeholder="-" value="${pmLate}"
                onchange="manualEdit('${s.name}','pm_late',this.value,this)" /></td>
            <td><input class="cell-input ${outTime ? 'has-value' : ''}" 
                placeholder="-" value="${outTime}"
                onchange="manualEdit('${s.name}','checkout',this.value,this)" /></td>
        </tr>`;
    });
}

// ===== Manual edit handler =====
function manualEdit(name, field, value, el) {
    if (!records[name]) records[name] = { morning: null, afternoon: null, checkout: null };

    if (field === 'am_time') {
        if (!records[name].morning) records[name].morning = { time: '', late: 0 };
        records[name].morning.time = value;
    } else if (field === 'am_late') {
        if (!records[name].morning) records[name].morning = { time: '', late: 0 };
        // store raw text â€” convert mins if number entered
        const mins = parseInt(value);
        records[name].morning.late = isNaN(mins) ? 0 : mins;
        // keep display text as-is
    } else if (field === 'pm_time') {
        if (!records[name].afternoon) records[name].afternoon = { time: '', late: 0 };
        records[name].afternoon.time = value;
    } else if (field === 'pm_late') {
        if (!records[name].afternoon) records[name].afternoon = { time: '', late: 0 };
        const mins = parseInt(value);
        records[name].afternoon.late = isNaN(mins) ? 0 : mins;
    } else if (field === 'checkout') {
        records[name].checkout = value;
    }

    el.classList.toggle('has-value', !!value);
    saveRecords();
}

async function submitAttendance(type) {
    const name = document.getElementById('staff-name').value;
    if (!name) return showToast("áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸáˆáŸ’á˜áŸ„áŸ‡!", 'error');

    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
    const time24 = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
    const dateStr = now.toLocaleDateString('km-KH');

    const staff = STAFF_LIST.find(s => s.name === name);
    const role = staff ? staff.role : 'N/A';

    if (!records[name]) records[name] = { morning: null, afternoon: null, checkout: null };

    let lateMins = 0;
    let label = "";

    if (type === 'morning') {
        if (records[name].morning) return showToast("á¢áŸ’á“á€á”á¶á“áŸáŸ’á€áŸá“á–áŸ’ášá¹á€ášá½á…á á¾á™!", 'error');
        const [th, tm] = CONFIG.morningLate.split(':').map(Number);
        const [ch, cm] = time24.split(':').map(Number);
        lateMins = Math.max(0, (ch * 60 + cm) - (th * 60 + tm));
        records[name].morning = { time: timeStr, late: lateMins };
        label = "â˜€ï¸ Morning Check-In";
    } else if (type === 'afternoon') {
        if (records[name].afternoon) return showToast("á¢áŸ’á“á€á”á¶á“áŸáŸ’á€áŸá“ááŸ’á„áŸƒášá½á…á á¾á™!", 'error');
        const [th, tm] = CONFIG.afternoonLate.split(':').map(Number);
        const [ch, cm] = time24.split(':').map(Number);
        lateMins = Math.max(0, (ch * 60 + cm) - (th * 60 + tm));
        records[name].afternoon = { time: timeStr, late: lateMins };
        label = "ğŸŒ¤ï¸ Afternoon Check-In";
    } else {
        if (records[name].checkout) return showToast("á¢áŸ’á“á€á”á¶á“áŸáŸ’á€áŸá“á…áŸá‰ášá½á…á á¾á™!", 'error');
        records[name].checkout = timeStr;
        label = "ğŸšª Check-Out";
    }

    const lateInfo = (type !== 'checkout' && lateMins > 0) 
        ? `âš ï¸ á™áºá: ${formatLate(lateMins)}` 
        : (type !== 'checkout' ? 'âœ… á‘á¶á“áŸ‹á–áŸá›' : '');

    sendToTelegram(`ğŸ”” <b>${label} | MIKIDS</b>\nğŸ“… ${dateStr}\nğŸ‘¤ áˆáŸ’á˜áŸ„áŸ‡: <b>${name}</b>\nRole: <b>${role}</b>\nâ° á˜áŸ‰áŸ„á„: ${timeStr}\n${lateInfo}`);
    
    saveRecords();
    showToast("âœ… áŸáŸ’á€áŸá“á‡áŸ„á‚á‡áŸá™!", 'success');
    renderTable();
}

function sendSummaryToTelegram() {
    const dateStr = new Date().toLocaleDateString('km-KH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    let msg = `ğŸ“Š <b>ášá”á¶á™á€á¶ášááŸáŸášá»á”</b>\nğŸ“… ${dateStr}\n\n`;

    STAFF_LIST.forEach((s, i) => {
        const r = records[s.name];
        if (r && (r.morning || r.afternoon || r.checkout)) {
            const m = r.morning ? r.morning.time : '-';
            const a = r.afternoon ? r.afternoon.time : '-';
            const o = r.checkout ? r.checkout : '-';
            msg += `${i+1}. âœ… <b>${s.name}</b>\n   AM: ${m} | PM: ${a} | Out: ${o}\n`;
        } else {
            msg += `${i+1}. âŒ <b>${s.name}</b>: á¢áœááŸ’áá˜á¶á“\n`;
        }
    });

    sendToTelegram(msg);
    showToast("ğŸ“¤ á•áŸ’á‰á¾ášá”á¶á™á€á¶ášááŸášá½á…ášá¶á›áŸ‹!");
}

function resetRecords() {
    if (!confirm("áá¾á¢áŸ’á“á€á–á·áá‡á¶á…á„áŸ‹á›á»á”á‘á·á“áŸ’á“á“áŸá™ááŸ’á„áŸƒá“áŸáŸ‡á‘á¶áŸ†á„á¢áŸáŸ‹?")) return;
    records = {};
    localStorage.removeItem('mikids_v2_db');
    renderTable();
    showToast("ğŸ—‘ï¸ á›á»á”á‘á·á“áŸ’á“á“áŸá™ášá½á…ášá¶á›áŸ‹!", 'error');
}

function sendToTelegram(msg) {
    fetch(`https://api.telegram.org/bot${CONFIG.token}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: CONFIG.chatId, text: msg, parse_mode: 'HTML' })
    });
}

window.onload = () => {
    new QRCode(document.getElementById("qrcode"), { text: CONFIG.githubLink, width: 150, height: 150 });
    const select = document.getElementById('staff-name');
    select.innerHTML = '<option value="">-- Select --</option>' + STAFF_LIST.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
    renderTable();
};
</script>
</body>
</html>